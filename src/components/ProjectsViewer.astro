---
import ProjectTechs from '@components/ProjectTechs.astro';
import ProjectModal from '@components/ProjectModal.astro';

import '@styles/bounce.css';

interface Props {
  data: any[];
}

const { data } = Astro.props;
const renderedData = await Promise.all(data.map((post) => post.render()));
---
<script>
  const contentStyling = {
    'h2': 'text-3xl font-handwriting mb-1 mt-2',
    'h3': 'text-2xl font-handwriting mb-1 mt-2',
    'h4': 'text-xl font-handwriting mb-1 mt-2',
    'h5': 'text-lg font-handwriting mb-1 mt-2',
    'p': 'font-body text-md py-2',
    'a': 'font-display outline-none font-bold'
  }

  const contentEntries = [...document.getElementsByClassName('project-content')];
  contentEntries.forEach((entry: Element) => {
    Object.entries(contentStyling).forEach(([tag, style]) => {
      const styleClasses = style.split(" ");
        const elements = entry.getElementsByTagName(tag);
        for (let i = 0; i < elements.length; i++) {
          elements[i].classList.add(...styleClasses);
        }
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const projectCards = [...document.getElementsByClassName('project-card')];
    projectCards.forEach((entry: Element) => {
      const entryKey = (entry.getAttribute('data-key') || '').replace('-card','-modal');
      const modalElement = document.getElementById(entryKey) as HTMLDialogElement;
      modalElement?.getElementsByTagName('button')[0].addEventListener('click', () => {
        document.getElementById("content")?.classList.remove(...['opacity-25', 'blur']);
        modalElement.close();
      });
      entry.addEventListener('click', () => {
        document.getElementById("content")?.classList.add(...['opacity-25', 'blur']);
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            document.getElementById("content")?.classList.remove(...['opacity-25', 'blur']);
            modalElement.close();
          }
        });
        modalElement.showModal();
      });
    })
  });
</script>

<main class="flex flex-col lg:flex-row items-center justify-center w-full gap-4 lg:gap-10">
  {
    renderedData && renderedData.map((post) => {
      const frontmatter = post.remarkPluginFrontmatter;
      const simpleTitle = frontmatter.title.replace(/\s/g, "").toLowerCase().replace(/[^a-zA-Z0-9 ]/g, '');
      return (
        <>
          <article 
            data-key={`${simpleTitle}-card`} 
            class='project-card doodle-border flex flex-col flex-wrap items-center justify-center p-2 lg:p-4 w-[95%] lg:w-[40%] cursor-pointer hover:-translate-y-2 duration-500'
          >
            <h1 class='text-2xl lg:text-5xl font-bold font-handwriting mt-2 mb-4 lg:mt-5 lg:mb-7 text-center mx-auto'>{frontmatter.title}</h1>
            <ProjectTechs
              techs={frontmatter.techs}
              label=""
            />
            <p class='font-body text-sm lg:text-md mt-4 lg:mt-8 text-justify'>{frontmatter.description}</p>
          </article>
          <ProjectModal id={`${simpleTitle}-modal`} open={'See more'}>
            <section class="project-content text-foreground w-full lg:w-auto" slot="main">
              <p class='text-5xl lg:text-7xl font-bold font-handwriting mt-2 mb-3 lg:mt-5 lg:mb-7 text-center mx-auto'>{frontmatter.title}</p>
              <img
                src={`assets/thumbnails/${frontmatter.image}`}
                class="max-h-48 lg:max-h-96 my-4 lg:my-8 mx-auto"
              />
              <div class="flex flex-col lg:flex-row lg:items-center w-full">
                <ProjectTechs 
                  techs={frontmatter.techs}
                  label="Tech stack:"
                />
                <div class="flex flex-row items-center justify-center lg:ml-auto">
                  Date:
                  <span class="ml-2 text-sm font-body">{frontmatter.date}</span>
                </div>
              </div>
              <hr class="w-full my-2 lg:my-4"/>
              <post.Content/>
              <nav class="flex flex-row justify-between mt-2">
                <button
                  slot='close'
                  id={`${simpleTitle}-modal-close`}
                  class="py-1 lg:px-1 mt-auto text-md lg:text-xl font-handwriting hover:-translate-x-2 duration-500 h-fit"
                >
                  Close modal
                </button>
                <button
                  slot='close'
                  id={`${simpleTitle}-modal-close`}
                  class="px-2 lg:px-3 mt-auto py-1 lg:py-2 mt-6 hover:translate-x-2 duration-500 h-fit"
                >
                  <a href={frontmatter.link} class="font-handwriting text-2xl lg:text-4xl">
                    Check it out
                  </a>
                </button>
              </nav>
            </section>
          </ProjectModal>
        </>
      )
    })
  }
</main>
